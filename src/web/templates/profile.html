{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}

<div class="max-w-3xl mx-auto animate-fade-in">
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-[var(--color-heading)]">Settings</h1>
    <p class="text-sm text-[var(--color-muted)] mt-1">{{ current_user.email }} Â· Member since {{ current_user.created_at.strftime('%b %Y') }}</p>
  </div>

  <div class="space-y-6">
    {# â•â•â• APPEARANCE â•â•â• #}
    <section class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-edge-subtle)] shadow-[var(--shadow-xs)] p-6 animate-fade-in-up stagger-1">
      <h2 class="font-semibold text-[var(--color-heading)] mb-4">ğŸ¨ Appearance</h2>
      <form hx-post="/api/profile/theme" hx-swap="none">
        <div class="flex items-center gap-6">
          {% for value, label, icon in [('light', 'Light', 'â˜€ï¸'), ('dark', 'Dark', 'ğŸŒ™'), ('auto', 'System', 'ğŸ’»')] %}
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="theme" value="{{ value }}" {{ 'checked' if current_user.theme == value }}
                class="accent-[var(--color-brand)]" />
            <span class="text-sm text-[var(--color-body)]">{{ icon }} {{ label }}</span>
          </label>
          {% endfor %}
          <button type="submit" id="theme-save-btn"
              class="ml-auto px-4 py-2 rounded-lg border border-[var(--color-edge)] text-sm font-medium text-[var(--color-muted)] hover:bg-[var(--color-surface-tertiary)] hover:text-[var(--color-heading)] transition-colors disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            Save
          </button>
        </div>
      </form>
    </section>

    {# â•â•â• LOCATION â•â•â• #}
    <section class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-edge-subtle)] shadow-[var(--shadow-xs)] p-6 animate-fade-in-up stagger-2">
      <h2 class="font-semibold text-[var(--color-heading)] mb-4">ğŸ“ Location</h2>
      <form hx-post="/api/profile/location" hx-swap="none" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">Home City</label>
            <input type="text" name="home_city" value="{{ current_user.home_city }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">Preferred Cities (comma-separated)</label>
            <input type="text" name="preferred_cities" value="{{ current_user.preferred_cities | join(', ') }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
        </div>
        <button type="submit" class="px-5 py-2.5 rounded-lg bg-[var(--color-brand)] text-white font-medium text-sm hover:bg-[var(--color-brand-hover)] active:scale-[0.98] transition-all">Save Location</button>
      </form>
    </section>

    {# â•â•â• CHILD PREFERENCES â•â•â• #}
    <section class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-edge-subtle)] shadow-[var(--shadow-xs)] p-6 animate-fade-in-up stagger-3">
      <h2 class="font-semibold text-[var(--color-heading)] mb-4">ğŸ§© Child Preferences</h2>
      <form hx-post="/api/profile/preferences" hx-swap="none" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">â¤ï¸ Loves</label>
            <input type="text" name="loves" value="{{ current_user.interest_profile.loves | join(', ') }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">ğŸ‘ Likes</label>
            <input type="text" name="likes" value="{{ current_user.interest_profile.likes | join(', ') }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">ğŸ‘ Dislikes</label>
            <input type="text" name="dislikes" value="{{ current_user.interest_profile.dislikes | join(', ') }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">ğŸ’¤ Nap Time</label>
            <input type="text" name="nap_time" value="{{ current_user.interest_profile.constraints.nap_time }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">ğŸŒ™ Bedtime</label>
            <input type="text" name="bedtime" value="{{ current_user.interest_profile.constraints.bedtime }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">ğŸ’° Budget ($)</label>
            <input type="number" name="budget" value="{{ current_user.interest_profile.constraints.budget_per_event }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">ğŸš— Max Drive (min)</label>
            <input type="number" name="max_drive" value="{{ current_user.interest_profile.constraints.max_drive_time_minutes }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
        </div>
        <button type="submit" class="px-5 py-2.5 rounded-lg bg-[var(--color-brand)] text-white font-medium text-sm hover:bg-[var(--color-brand-hover)] active:scale-[0.98] transition-all">Save Preferences</button>
      </form>
    </section>

    {# â•â•â• NOTIFICATIONS â•â•â• #}
    <section class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-edge-subtle)] shadow-[var(--shadow-xs)] p-6 animate-fade-in-up stagger-4">
      <h2 class="font-semibold text-[var(--color-heading)] mb-4">ğŸ”” Notifications</h2>
      <form hx-post="/api/profile/notifications" hx-swap="none" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">Childâ€™s Name</label>
            <input type="text" name="child_name" value="{{ current_user.child_name }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">Notification Email</label>
            <input type="email" name="email_to" value="{{ current_user.email_to }}"
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
        </div>
        <div>
          <p class="text-xs font-medium text-[var(--color-muted)] mb-2">Channels</p>
          <div class="flex flex-wrap gap-4">
            {% for ch in ['console', 'email', 'sms', 'telegram'] %}
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" name="channels" value="{{ ch }}" {{ 'checked' if ch in current_user.notification_channels }}
                  class="accent-[var(--color-brand)] rounded-sm" />
              <span class="text-sm text-[var(--color-body)] capitalize">{{ ch }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        <button type="submit" class="px-5 py-2.5 rounded-lg bg-[var(--color-brand)] text-white font-medium text-sm hover:bg-[var(--color-brand-hover)] active:scale-[0.98] transition-all">Save Notifications</button>
      </form>
    </section>

    {# â•â•â• PASSWORD â•â•â• #}
    <section class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-edge-subtle)] shadow-[var(--shadow-xs)] p-6 animate-fade-in-up stagger-5">
      <h2 class="font-semibold text-[var(--color-heading)] mb-4">ğŸ”’ Change Password</h2>
      <form hx-post="/api/profile/password" hx-swap="none" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">Current Password</label>
            <input type="password" name="current_password" required
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">New Password</label>
            <input type="password" name="new_password" required
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
          <div>
            <label class="block text-xs font-medium text-[var(--color-muted)] mb-1.5">Confirm Password</label>
            <input type="password" name="confirm_password" required
                class="w-full px-3.5 py-2.5 border border-[var(--color-edge)] rounded-lg text-sm bg-[var(--color-surface-secondary)] text-[var(--color-heading)] focus:outline-hidden focus:ring-2 focus:ring-[var(--color-brand)]/30 focus:border-[var(--color-brand)] transition-all" />
          </div>
        </div>
        <button type="submit" class="px-5 py-2.5 rounded-lg border border-[var(--color-edge)] text-sm font-medium text-[var(--color-muted)] hover:bg-[var(--color-surface-tertiary)] hover:text-[var(--color-heading)] transition-colors">Change Password</button>
      </form>
    </section>
  </div>
</div>

{# Theme save button enable/disable logic #}
<script>
  (function() {
    var radios = document.querySelectorAll('input[name="theme"]');
    var btn = document.getElementById('theme-save-btn');
    var saved = '{{ current_user.theme }}';
    radios.forEach(function(r) {
      r.addEventListener('change', function() {
        btn.disabled = (r.value === saved);
      });
    });
    document.body.addEventListener('htmx:afterRequest', function(evt) {
      var trigger = evt.detail.xhr?.getResponseHeader('HX-Trigger');
      if (trigger && trigger.indexOf('changeTheme') !== -1) {
        try {
          var data = JSON.parse(trigger);
          if (data.changeTheme) {
            saved = data.changeTheme.theme;
            btn.disabled = true;
          }
        } catch(e) {}
      }
    });
  })();
</script>

{% endblock %}
