{# Events table + pagination â€” HTMX swappable partial #}
{% set _hx_common %}
    hx-target="#events-results"
    hx-swap="innerHTML"
    hx-push-url="true"
    hx-indicator="#events-results-wrapper"
{% endset %}
{% set _qs %}q={{ q | urlencode }}&city={{ city | urlencode }}&source={{ source | urlencode }}&tagged={{ tagged }}&score_min={{ score_min if score_min is not none else '' }}&sort={{ sort }}{% endset %}

{# Results summary #}
<div class="flex items-center justify-between mb-3">
    <p class="text-sm text-gray-500">
        Showing {{ ((page - 1) * per_page) + 1 }}â€“{{ [page * per_page, total] | min }} of {{ total }} events
    </p>
</div>

{# â”€â”€ Desktop table (hidden on mobile) â”€â”€ #}
<div class="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-x-auto">
    <table class="w-full border-collapse">
        <thead>
            <tr class="bg-gray-50 dark:bg-gray-700/50">
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">Date</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">Time</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">Event</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">City</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">Source</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">Score</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700">Categories</th>
                <th class="text-left py-2.5 px-2.5 font-semibold text-gray-500 dark:text-gray-400 text-xs uppercase border-b border-gray-200 dark:border-gray-700"></th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
                {% include "partials/_event_row.html" %}
            {% else %}
                <tr>
                    <td colspan="8" class="text-center py-8 text-gray-400 dark:text-gray-500 text-sm">No events match your filters.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# â”€â”€ Mobile card layout (hidden on desktop) â”€â”€ #}
<div class="md:hidden space-y-3">
    {% for event in events %}
    <a href="/event/{{ event.id }}" class="block bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 hover:shadow-md transition">
        <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-sm text-gray-900 dark:text-white truncate">{{ event.title[:70] }}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    ğŸ“… {{ event.start_time.strftime("%m/%d %a Â· %-I:%M%p") }}
                    Â· ğŸ“ {{ event.location_city }}
                </p>
            </div>
            {% if event.tags %}
            <span class="shrink-0 inline-block px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300">{{ event.tags.toddler_score }}/10</span>
            {% else %}
            <span class="shrink-0 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-100 dark:bg-orange-900/40 text-orange-800 dark:text-orange-300">untagged</span>
            {% endif %}
        </div>
        <div class="flex flex-wrap gap-1.5 mt-2">
            {% set source_label = event.source.replace("custom:", "") if event.source.startswith("custom:") else event.source %}
            <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">{{ source_label[:20] }}</span>
            {% if event.tags and event.tags.categories %}
            <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">{{ event.tags.categories[:2] | join(", ") }}</span>
            {% endif %}
        </div>
    </a>
    {% else %}
    <div class="text-center py-8 text-gray-400 dark:text-gray-500 text-sm">No events match your filters.</div>
    {% endfor %}
</div>

{# Pagination #}
{% if total_pages > 1 %}
<nav class="flex items-center justify-between mt-4 gap-2">
    <div class="flex items-center gap-1 flex-wrap">
        {# Previous #}
        {% if page > 1 %}
        <button hx-get="/events?{{ _qs }}&page={{ page - 1 }}" {{ _hx_common }}
            class="px-3 py-2 md:py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 flex items-center justify-center"
        >â† Prev</button>
        {% endif %}

        {# Page numbers â€” show fewer on mobile #}
        {% set page_start = [1, page - 1] | max %}
        {% set page_end = [total_pages, page + 1] | min %}

        {% if page_start > 1 %}
        <button hx-get="/events?{{ _qs }}&page=1" {{ _hx_common }}
            class="hidden sm:flex px-3 py-2 md:py-1.5 rounded-lg text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 items-center justify-center"
        >1</button>
        {% if page_start > 2 %}
        <span class="hidden sm:inline px-1 text-gray-400">â€¦</span>
        {% endif %}
        {% endif %}

        {% for p in range(page_start, page_end + 1) %}
        <button
            {% if p != page %}hx-get="/events?{{ _qs }}&page={{ p }}" {{ _hx_common }}{% endif %}
            class="px-3 py-2 md:py-1.5 rounded-lg text-sm cursor-pointer transition min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 flex items-center justify-center {{ 'bg-indigo-500 text-white font-semibold' if p == page else 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700' }}"
        >{{ p }}</button>
        {% endfor %}

        {% if page_end < total_pages %}
        {% if page_end < total_pages - 1 %}
        <span class="hidden sm:inline px-1 text-gray-400">â€¦</span>
        {% endif %}
        <button hx-get="/events?{{ _qs }}&page={{ total_pages }}" {{ _hx_common }}
            class="hidden sm:flex px-3 py-2 md:py-1.5 rounded-lg text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 items-center justify-center"
        >{{ total_pages }}</button>
        {% endif %}

        {# Next #}
        {% if page < total_pages %}
        <button hx-get="/events?{{ _qs }}&page={{ page + 1 }}" {{ _hx_common }}
            class="px-3 py-2 md:py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 flex items-center justify-center"
        >Next â†’</button>
        {% endif %}
    </div>

    <p class="text-xs text-gray-400 shrink-0">{{ page }}/{{ total_pages }}</p>
</nav>
{% endif %}
