{% set status_badges = {
    "active": {"class": "bg-green-100 text-green-800", "icon": "âœ…"},
    "stale": {"class": "bg-orange-100 text-orange-800", "icon": "âš ï¸"},
    "failed": {"class": "bg-red-100 text-red-800", "icon": "âŒ"},
    "analyzing": {"class": "bg-blue-100 text-blue-800", "icon": "ğŸ”„"},
    "pending": {"class": "bg-gray-100 text-gray-700", "icon": "â³"},
    "disabled": {"class": "bg-gray-100 text-gray-500", "icon": "â¸ï¸"},
} %}
{% set badge = status_badges.get(source.status, status_badges["pending"]) %}
<div class="bg-white rounded-xl p-4 shadow-sm mb-3">
    <div class="flex items-start justify-between">
        <div>
            <div class="flex items-center gap-2">
                <a href="/source/{{ source.id }}" class="font-semibold text-gray-900 hover:text-indigo-600">{{ source.name }}</a>
                <span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold {{ badge.class }}">{{ badge.icon }} {{ source.status }}</span>
            </div>
            <div class="text-gray-400 text-xs mt-0.5">{{ source.url }}</div>
            <div class="text-gray-500 text-xs mt-1">
                {% if source.recipe_json %}
                    Strategy: {{ "JSON-LD" if '"jsonld"' in source.recipe_json else "CSS selectors" }}
                {% endif %}
                {% if source.last_event_count %}
                    Â· {{ source.last_event_count }} events
                {% endif %}
                {% if source.last_scraped_at %}
                    Â· Last: {{ source.last_scraped_at.strftime("%b %d, %-I:%M%p") }}
                {% endif %}
            </div>
            {% if source.last_error %}
            <div class="text-red-500 text-xs mt-1">Error: {{ source.last_error[:100] }}</div>
            {% endif %}
        </div>
        <div class="flex gap-1.5">
            <button hx-post="/api/sources/{{ source.id }}/test" hx-target="#test-{{ source.id }}" hx-swap="innerHTML" hx-indicator="this"
                class="px-2.5 py-1 rounded-lg border border-gray-300 text-xs text-gray-700 hover:bg-gray-100 cursor-pointer transition">
                ğŸ§ª Test <span class="htmx-indicator"><span class="spinner" style="border-color:rgba(0,0,0,.2);border-top-color:#333;width:10px;height:10px"></span></span>
            </button>
            {% if source.status in ("stale", "failed") %}
            <button hx-post="/api/sources/{{ source.id }}/analyze" hx-target="#test-{{ source.id }}" hx-swap="innerHTML" hx-indicator="this"
                class="px-2.5 py-1 rounded-lg border border-gray-300 text-xs text-gray-700 hover:bg-gray-100 cursor-pointer transition">
                ğŸ”„ Re-analyze <span class="htmx-indicator"><span class="spinner" style="border-color:rgba(0,0,0,.2);border-top-color:#333;width:10px;height:10px"></span></span>
            </button>
            {% endif %}
            <button hx-post="/api/sources/{{ source.id }}/toggle" hx-target="#test-{{ source.id }}" hx-swap="innerHTML"
                class="px-2.5 py-1 rounded-lg border border-gray-300 text-xs text-gray-700 hover:bg-gray-100 cursor-pointer transition">
                {{ "â¸ï¸ Disable" if source.enabled else "â–¶ï¸ Enable" }}
            </button>
            <button hx-delete="/api/sources/{{ source.id }}" hx-target="#test-{{ source.id }}" hx-swap="innerHTML" hx-confirm="Delete this source and all its events?"
                class="px-2.5 py-1 rounded-lg border border-red-300 text-xs text-red-600 hover:bg-red-50 cursor-pointer transition">
                ğŸ—‘ï¸
            </button>
        </div>
    </div>
    <div id="test-{{ source.id }}" class="mt-2"></div>
</div>
