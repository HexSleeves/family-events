<!doctype html>
<html
  lang="en"
  class="{% if current_user and current_user.theme == 'dark' %}dark{% endif %}"
>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Family Events{% endblock %} - Family Events</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <script>
      // Apply theme immediately to prevent FOUC
      (function() {
          var theme = '{{ current_user.theme if current_user else "auto" }}';
          if (theme === 'auto') {
              if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                  document.documentElement.classList.add('dark');
              } else {
                  document.documentElement.classList.remove('dark');
              }
          }
          // dark/light handled by server-rendered class on <html>
      })();
    </script>
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 leading-relaxed transition-colors"
    hx-indicator="#global-progress"
  >
    {# Global progress bar #}
    <div id="global-progress"><div class="bar"></div></div>

    <header
      class="bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-700 dark:to-purple-700 text-white py-4 mb-6"
    >
      <div class="max-w-4xl mx-auto px-4 flex items-center gap-4">
        <a
          href="/"
          class="text-xl font-bold hover:opacity-90 transition shrink-0"
          >üåü Family Events</a
        >
        {# Hamburger button ‚Äî mobile only #}
        <button
          id="menu-toggle"
          onclick="
            document.getElementById('mobile-menu').classList.toggle('hidden')
          "
          class="ml-auto md:hidden p-2 rounded-md bg-white/15 hover:bg-white/30 transition cursor-pointer"
          aria-label="Toggle menu"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
        {# Desktop nav #}
        <nav class="ml-auto hidden md:flex gap-2 items-center">
          <a
            href="/"
            class="px-3 py-1.5 rounded-md bg-white/15 hover:bg-white/30 hover:-translate-y-0.5 active:scale-95 text-sm transition-all duration-200"
            >üè† Dashboard</a
          >
          <a
            href="/events"
            class="px-3 py-1.5 rounded-md bg-white/15 hover:bg-white/30 hover:-translate-y-0.5 active:scale-95 text-sm transition-all duration-200"
            >üìÖ Events</a
          >
          <a
            href="/weekend"
            class="px-3 py-1.5 rounded-md bg-white/15 hover:bg-white/30 hover:-translate-y-0.5 active:scale-95 text-sm transition-all duration-200"
            >üéâ Weekend</a
          >
          <a
            href="/sources"
            class="px-3 py-1.5 rounded-md bg-white/15 hover:bg-white/30 hover:-translate-y-0.5 active:scale-95 text-sm transition-all duration-200"
            >üì° Sources</a
          >
          {% if current_user %}
          <span class="mx-1 text-white/40">|</span>
          <a
            href="/profile"
            class="px-3 py-1.5 rounded-md bg-white/15 hover:bg-white/30 hover:-translate-y-0.5 active:scale-95 text-sm transition-all duration-200"
            >üë§ {{ current_user.display_name }}</a
          >
          <a
            href="/logout"
            class="px-3 py-1.5 rounded-md bg-white/15 hover:bg-white/30 hover:-translate-y-0.5 active:scale-95 text-sm transition-all duration-200"
            >‚Ü© Logout</a
          >
          {% else %}
          <span class="mx-1 text-white/40">|</span>
          <a
            href="/login"
            class="px-3 py-1.5 rounded-md bg-white/20 hover:bg-white/30 text-sm font-medium transition"
            >Log In</a
          >
          <a
            href="/signup"
            class="px-3 py-1.5 rounded-md bg-white/30 hover:bg-white/40 text-sm font-medium transition"
            >Sign Up</a
          >
          {% endif %}
        </nav>
      </div>
      {# Mobile menu ‚Äî hidden by default, animated on toggle #}
      <nav
        id="mobile-menu"
        class="hidden md:hidden mt-3 px-4 pb-2 space-y-1 animate-slide-down"
      >
        <a
          href="/"
          class="block px-3 py-2 rounded-md bg-white/10 hover:bg-white/20 text-sm transition"
          >üè† Dashboard</a
        >
        <a
          href="/events"
          class="block px-3 py-2 rounded-md bg-white/10 hover:bg-white/20 text-sm transition"
          >üìÖ Events</a
        >
        <a
          href="/weekend"
          class="block px-3 py-2 rounded-md bg-white/10 hover:bg-white/20 text-sm transition"
          >üéâ Weekend</a
        >
        <a
          href="/sources"
          class="block px-3 py-2 rounded-md bg-white/10 hover:bg-white/20 text-sm transition"
          >üì° Sources</a
        >
        <div class="border-t border-white/20 my-2"></div>
        {% if current_user %}
        <a
          href="/profile"
          class="block px-3 py-2 rounded-md bg-white/10 hover:bg-white/20 text-sm transition"
          >üë§ {{ current_user.display_name }}</a
        >
        <a
          href="/logout"
          class="block px-3 py-2 rounded-md bg-white/10 hover:bg-white/20 text-sm transition"
          >‚Ü© Logout</a
        >
        {% else %}
        <a
          href="/login"
          class="block px-3 py-2 rounded-md bg-white/15 hover:bg-white/25 text-sm font-medium transition"
          >Log In</a
        >
        <a
          href="/signup"
          class="block px-3 py-2 rounded-md bg-white/20 hover:bg-white/30 text-sm font-medium transition"
          >Sign Up</a
        >
        {% endif %}
      </nav>
    </header>
    <main class="max-w-4xl mx-auto px-4 pb-12 animate-fade-in">
      {% block content %}{% endblock %}
    </main>

    {# Toast container ‚Äî bottom-center on mobile, top-right on desktop #}
    <div
      id="toast-container"
      class="fixed flex flex-col gap-2 pointer-events-none left-4 right-4 bottom-4 items-center md:left-auto md:bottom-auto md:top-4 md:right-4 md:items-end"
      style="z-index: 10000; max-width: 24rem"
    ></div>

    <script>
      (function () {
        var icons = {
          success: "\u2705",
          error: "\u274c",
          warning: "\u26a0\ufe0f",
          info: "\u2139\ufe0f",
        };
        var bgColors = {
          success: "#16a34a",
          error: "#dc2626",
          warning: "#d97706",
          info: "#2563eb",
        };

        function showToast(message, variant, duration) {
          variant = variant || "success";
          duration = duration || 3500;
          var container = document.getElementById("toast-container");
          var el = document.createElement("div");
          el.style.cssText =
            "background:" +
            (bgColors[variant] || bgColors.success) +
            ";" +
            "color:#fff;font-size:0.875rem;font-weight:500;" +
            "padding:0.75rem 1rem;border-radius:0.5rem;" +
            "box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);" +
            "pointer-events:auto;cursor:pointer;" +
            "display:flex;align-items:center;gap:0.5rem;";
          el.className = "toast-enter";
          el.innerHTML =
            "<span>" +
            (icons[variant] || "") +
            "</span><span>" +
            message +
            "</span>";
          container.appendChild(el);

          var timer = setTimeout(function () {
            dismiss(el);
          }, duration);
          el.onclick = function () {
            dismiss(el);
          };

          function dismiss(node) {
            clearTimeout(timer);
            node.classList.remove("toast-enter");
            node.classList.add("toast-exit");
            node.addEventListener(
              "animationend",
              function () {
                node.remove();
              },
              { once: true },
            );
          }
        }

        function changeTheme(theme) {
          theme = theme || "auto";
          // Resolve auto to actual preference
          var resolved = theme;
          if (theme === "auto") {
            resolved = window.matchMedia("(prefers-color-scheme: dark)").matches
              ? "dark" : "light";
          }
          if (resolved === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
          // Store current mode so the system listener knows whether to act
          document.documentElement.dataset.theme = theme;
        }

        // Listen for OS theme changes (only applies when user chose 'auto')
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function() {
          if (document.documentElement.dataset.theme === "auto") {
            changeTheme("auto");
          }
        });

        if (!window._toastListenersAttached) {
          window._toastListenersAttached = true;

          // Single handler: parse HX-Trigger header from every HTMX response.
          // We don't use HTMX's auto-dispatched custom events because they
          // don't fire reliably with hx-swap="none" in HTMX 2.0.
          document.body.addEventListener("htmx:afterRequest", function (e) {
            var xhr = e.detail.xhr;
            if (!xhr) return;
            var trigger = xhr.getResponseHeader("HX-Trigger");
            if (!trigger) return;
            try {
              var parsed = JSON.parse(trigger);
              if (parsed.showToast) {
                var d = parsed.showToast;
                showToast(d.message || "Done", d.variant || "success", d.duration);
              }
              if (parsed.changeTheme) {
                changeTheme(parsed.changeTheme.theme || "auto");
              }
            } catch (err) {
              /* not JSON, ignore */
            }
          });
        }

        window.showToast = showToast;
        window.changeTheme = changeTheme;
      })();
    </script>
  </body>
</html>
